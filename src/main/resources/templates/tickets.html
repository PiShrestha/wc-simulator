<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>World Cup Ticket Explorer</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css"
    />
    <style>
      .card-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.72);
        opacity: 0;
        transition: opacity 150ms ease;
      }
      .card:hover .card-overlay,
      .card:focus-within .card-overlay {
        opacity: 1;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <header class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <p
            class="text-emerald-400 font-semibold uppercase tracking-widest text-xs"
          >
            World Cup Ticket Explorer
          </p>
          <h1 class="text-3xl font-bold mt-1">Tickets & Simulator</h1>
          <p class="text-slate-400 mt-2 max-w-3xl">
            Browse venue matches and simulate possible games. Category 1–3
            prices remain hidden until you hover a match.
          </p>
        </div>
        <a
          href="/"
          class="px-3 py-2 rounded-lg border border-slate-700 text-sm font-semibold text-slate-200 hover:border-emerald-400 hover:text-emerald-200 transition"
          >← Back home</a
        >
      </header>

      <div class="mt-6 flex gap-2">
        <button
          id="tab-venues"
          type="button"
          class="tab-btn px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 font-semibold text-sm hover:border-emerald-400"
        >
          Venue Matches
        </button>
        <button
          id="tab-sim"
          type="button"
          class="tab-btn px-4 py-2 rounded-lg border border-slate-800 bg-slate-900 font-semibold text-sm text-slate-400 hover:border-emerald-400"
        >
          Simulation
        </button>
      </div>

      <section id="venue-view" class="mt-4 grid lg:grid-cols-[260px_1fr] gap-4">
        <aside
          class="bg-slate-900/70 border border-slate-800 rounded-xl p-4 space-y-3"
        >
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Venues</h2>
            <span id="venue-count" class="text-xs text-slate-400"></span>
          </div>
          <div
            id="venue-list"
            class="space-y-2 overflow-y-auto max-h-[70vh]"
          ></div>
        </aside>

        <div class="space-y-3">
          <div
            class="flex items-center justify-between flex-wrap gap-2 bg-slate-900/70 border border-slate-800 rounded-xl px-4 py-3"
          >
            <div>
              <p
                class="text-xs uppercase tracking-wide text-emerald-300 font-semibold"
              >
                Selected Venue
              </p>
              <h3 id="active-venue-label" class="text-xl font-bold">
                All venues
              </h3>
              <p id="active-venue-hint" class="text-slate-400 text-sm">
                Hover to preview, click to lock the venue.
              </p>
            </div>
            <div class="flex gap-2">
              <button
                id="show-all"
                class="px-3 py-2 text-sm font-semibold rounded-lg border border-slate-700 text-slate-200 hover:border-emerald-400"
              >
                Show all venues
              </button>
              <a
                href="/tickets.json"
                class="px-3 py-2 text-sm font-semibold rounded-lg border border-emerald-500 text-emerald-200 hover:bg-emerald-500/10"
                >Download JSON</a
              >
            </div>
          </div>

          <div id="venue-stage-container" class="space-y-4"></div>
        </div>
      </section>

      <section id="sim-view" class="hidden mt-6">
        <div
          class="bg-slate-900/70 border border-slate-800 rounded-xl p-4 flex flex-wrap gap-3 items-center justify-between"
        >
          <div>
            <p
              class="text-xs uppercase tracking-wide text-emerald-300 font-semibold"
            >
              Simulation
            </p>
            <h3 class="text-xl font-bold">Venue-specific projection</h3>
            <p class="text-slate-400 text-sm">
              Hover a projected match to reveal Category 1–3 pricing.
            </p>
          </div>
          <div class="flex gap-2 items-center flex-wrap">
            <label for="sim-venue" class="text-sm font-semibold text-slate-200"
              >Venue</label
            >
            <select
              id="sim-venue"
              class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:border-emerald-400"
            ></select>
            <button
              id="run-sim"
              class="px-3 py-2 text-sm font-semibold rounded-lg bg-emerald-500 text-slate-900 hover:bg-emerald-400"
              type="button"
            >
              Simulate
            </button>
          </div>
        </div>
        <div id="sim-stage-container" class="mt-4 space-y-4"></div>
      </section>
    </div>

    <script th:inline="javascript">
      const MATCHES = /*[[${matches}]]*/ [];
      const VENUES = /*[[${venues}]]*/ [];
      const STAGE_ORDER = /*[[${stageOrder}]]*/ [];
      const INITIAL_VENUE = /*[[${selectedVenue}]]*/ "";
    </script>
    <script>
      (function () {
        const coerceString = (val) => (typeof val === "string" ? val : "");
        const venues = Array.isArray(VENUES) ? VENUES : [];
        const matches = Array.isArray(MATCHES) ? MATCHES : [];
        const stageOrder = Array.isArray(STAGE_ORDER) ? STAGE_ORDER : [];
        const initialVenue = coerceString(INITIAL_VENUE);

        const tabVenues = document.getElementById("tab-venues");
        const tabSim = document.getElementById("tab-sim");
        const venueView = document.getElementById("venue-view");
        const simView = document.getElementById("sim-view");
        const venueList = document.getElementById("venue-list");
        const venueCount = document.getElementById("venue-count");
        const activeVenueLabel = document.getElementById("active-venue-label");
        const activeVenueHint = document.getElementById("active-venue-hint");
        const showAllBtn = document.getElementById("show-all");
        const venueStageContainer = document.getElementById(
          "venue-stage-container"
        );
        const simVenueSelect = document.getElementById("sim-venue");
        const simStageContainer = document.getElementById(
          "sim-stage-container"
        );
        const runSimBtn = document.getElementById("run-sim");

        const state = {
          activeTab: "venues",
          activeVenue:
            initialVenue && initialVenue.length > 0
              ? initialVenue
              : venues[0] || "All venues",
          previewVenue: null,
          simVenue:
            initialVenue && initialVenue.length > 0
              ? initialVenue
              : venues[0] || "",
        };

        init();

        function init() {
          venueCount.textContent = `${venues.length} venues`;
          renderVenues();
          renderVenueStages();
          populateSimVenues();
          renderSimStages();
          bindEvents();
          syncTabs();
        }

        function bindEvents() {
          showAllBtn.addEventListener("click", (e) => {
            e.preventDefault();
            setActiveVenue("All venues");
          });
          tabVenues.addEventListener("click", () => switchTab("venues"));
          tabSim.addEventListener("click", () => switchTab("sim"));
          runSimBtn.addEventListener("click", () => renderSimStages());
          simVenueSelect.addEventListener("change", (e) => {
            state.simVenue = e.target.value;
            state.activeVenue = state.simVenue;
            renderSimStages();
            renderVenueStages();
            highlightVenue(state.simVenue);
          });
        }

        function switchTab(tab) {
          state.activeTab = tab;
          if (tab === "sim") {
            if (state.activeVenue && state.activeVenue !== "All venues") {
              state.simVenue = state.activeVenue;
              simVenueSelect.value = state.simVenue;
            }
            renderSimStages();
          }
          syncTabs();
        }

        function syncTabs() {
          const isVenue = state.activeTab === "venues";
          tabVenues.classList.toggle("bg-slate-800", isVenue);
          tabVenues.classList.toggle("border-slate-700", isVenue);
          tabVenues.classList.toggle("text-slate-100", isVenue);
          tabVenues.classList.toggle("bg-slate-900", !isVenue);
          tabVenues.classList.toggle("text-slate-400", !isVenue);

          tabSim.classList.toggle("bg-slate-800", !isVenue);
          tabSim.classList.toggle("border-slate-700", !isVenue);
          tabSim.classList.toggle("text-slate-100", !isVenue);
          tabSim.classList.toggle("bg-slate-900", isVenue);
          tabSim.classList.toggle("text-slate-400", isVenue);

          venueView.classList.toggle("hidden", !isVenue);
          simView.classList.toggle("hidden", isVenue);
        }

        function renderVenues() {
          venueList.innerHTML = "";
          const allBtn = buildVenueButton(
            "All venues",
            matches.length,
            matches
          );
          venueList.appendChild(allBtn);
          venues.forEach((v) => {
            const scoped = matches.filter((m) => m.stadium === v);
            venueList.appendChild(buildVenueButton(v, scoped.length, scoped));
          });
          highlightVenue(state.activeVenue);
        }

        function buildVenueButton(name, count, scoped) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "w-full text-left px-3 py-2 rounded-lg border border-slate-800 bg-slate-900 hover:border-emerald-400 transition";
          btn.innerHTML = `<div class="flex items-center justify-between"><span class="font-semibold">${name}</span><span class="text-xs text-slate-400">${count}</span></div><p class="text-xs text-slate-500">${
            scoped[0]?.date || ""
          }</p>`;
          btn.addEventListener("mouseenter", () => previewVenue(name, scoped));
          btn.addEventListener("focus", () => previewVenue(name, scoped));
          btn.addEventListener("mouseleave", clearPreview);
          btn.addEventListener("blur", clearPreview);
          btn.addEventListener("click", () => {
            setActiveVenue(name);
            state.simVenue = name === "All venues" ? state.simVenue : name;
            simVenueSelect.value = state.simVenue;
            renderSimStages();
          });
          return btn;
        }

        function highlightVenue(name) {
          activeVenueLabel.textContent = name;
          activeVenueHint.textContent =
            "Hover to preview, click to lock the venue.";
        }

        function previewVenue(name, scoped) {
          if (name === state.activeVenue) return;
          state.previewVenue = name;
          activeVenueLabel.textContent = `${name} (preview)`;
          activeVenueHint.textContent = `${scoped.length} match(es) here; hover shows pricing on cards.`;
          renderVenueStages(name);
        }

        function clearPreview() {
          if (!state.previewVenue) return;
          state.previewVenue = null;
          activeVenueLabel.textContent = state.activeVenue;
          activeVenueHint.textContent =
            "Hover to preview, click to lock the venue.";
          renderVenueStages();
        }

        function setActiveVenue(name) {
          state.activeVenue = name;
          state.previewVenue = null;
          activeVenueLabel.textContent = name;
          activeVenueHint.textContent =
            "Hover to preview, click to lock the venue.";
          if (name !== "All venues") {
            state.simVenue = name;
            if (simVenueSelect) simVenueSelect.value = name;
          }
          renderVenueStages();
        }

        function groupByStage(list) {
          const map = {};
          list.forEach((m) => {
            const stage = m.stage || "Match";
            if (!map[stage]) map[stage] = [];
            map[stage].push(m);
          });
          const ordered = {};
          const order = stageOrder.length
            ? stageOrder
            : [
                "Final",
                "Semifinal",
                "Quarterfinal",
                "Round of 16",
                "Round of 32",
                "Third Place",
                "Match",
              ];
          order.forEach((stage) => {
            if (map[stage]) {
              ordered[stage] = map[stage].sort(
                (a, b) => (a.matchId || 0) - (b.matchId || 0)
              );
              delete map[stage];
            }
          });
          Object.keys(map).forEach((stage) => {
            ordered[stage] = map[stage].sort(
              (a, b) => (a.matchId || 0) - (b.matchId || 0)
            );
          });
          return ordered;
        }

        function renderVenueStages(previewName) {
          const venue = previewName || state.activeVenue;
          const scoped =
            venue === "All venues"
              ? matches
              : matches.filter((m) => m.stadium === venue);
          venueStageContainer.innerHTML = "";
          const grouped = groupByStage(scoped);
          Object.entries(grouped).forEach(([stage, list]) => {
            const stageBlock = document.createElement("div");
            stageBlock.className = "space-y-2";
            stageBlock.innerHTML = `<div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-400"></div><h4 class="text-lg font-semibold">${stage}</h4></div>`;
            const grid = document.createElement("div");
            grid.className = "grid sm:grid-cols-2 lg:grid-cols-3 gap-3";
            list.forEach((m) => grid.appendChild(buildMatchCard(m)));
            stageBlock.appendChild(grid);
            venueStageContainer.appendChild(stageBlock);
          });
        }

        function renderSimStages() {
          const venue = state.simVenue || venues[0] || "";
          const scoped = matches.filter((m) => m.stadium === venue);
          const grouped = groupByStage(scoped);
          simStageContainer.innerHTML = "";
          Object.entries(grouped).forEach(([stage, list]) => {
            const stageBlock = document.createElement("div");
            stageBlock.className = "space-y-2";
            stageBlock.innerHTML = `<div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-400"></div><h4 class="text-lg font-semibold">${stage}</h4></div>`;
            const grid = document.createElement("div");
            grid.className = "grid sm:grid-cols-2 lg:grid-cols-3 gap-3";
            list.forEach((m) => grid.appendChild(buildMatchCard(m)));
            stageBlock.appendChild(grid);
            simStageContainer.appendChild(stageBlock);
          });
        }

        function populateSimVenues() {
          simVenueSelect.innerHTML = "";
          venues.forEach((v) => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            simVenueSelect.appendChild(opt);
          });
          simVenueSelect.value = state.simVenue;
        }

        function buildMatchCard(match) {
          const card = document.createElement("article");
          card.className =
            "card relative group border border-slate-800 bg-slate-900/70 rounded-xl p-4 transition hover:border-emerald-400";

          const title = document.createElement("div");
          title.className = "flex items-center gap-2 mb-1";
          title.innerHTML = `<span class="text-xs font-semibold text-emerald-300 uppercase">Match ${match.matchId}</span>`;

          const meta = document.createElement("div");
          meta.className = "text-sm text-slate-400";
          meta.textContent = `${match.date || "TBD"} · ${
            match.time || "TBD"
          } · ${match.stadium || ""}`;

          const teams = document.createElement("div");
          teams.className = "mt-2 flex flex-wrap gap-2 items-center text-sm";
          (match.teams || []).forEach((team, idx) => {
            const pill = document.createElement("span");
            pill.className =
              "px-2 py-1 rounded-full bg-slate-800 border border-slate-700 text-slate-100 text-xs font-semibold";
            pill.textContent = team;
            teams.appendChild(pill);
            if (idx === 0 && (match.teams || []).length > 1) {
              const vs = document.createElement("span");
              vs.className = "text-slate-500 text-xs font-semibold";
              vs.textContent = "vs";
              teams.appendChild(vs);
            }
          });

          const overlay = document.createElement("div");
          overlay.className =
            "card-overlay rounded-xl p-4 flex flex-col justify-center gap-2 text-sm";
          overlay.innerHTML = `
            <div class="font-semibold text-emerald-200">Ticket categories</div>
            ${
              renderPriceLine("Category 1", match.tickets?.["Category 1"])
                .outerHTML
            }
            ${
              renderPriceLine("Category 2", match.tickets?.["Category 2"])
                .outerHTML
            }
            ${
              renderPriceLine("Category 3", match.tickets?.["Category 3"])
                .outerHTML
            }
          `;

          card.append(title, meta, teams, overlay);
          return card;
        }

        function renderPriceLine(label, price) {
          const row = document.createElement("div");
          row.className =
            "flex items-center justify-between bg-slate-800/70 border border-slate-700 rounded-lg px-3 py-2";
          row.innerHTML = `<span class="font-semibold">${label}</span><span class="text-emerald-300 font-bold">${formatPrice(
            price
          )}</span>`;
          return row;
        }

        function formatPrice(val) {
          if (val === undefined || val === null || Number.isNaN(Number(val)))
            return "Not listed";
          return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          }).format(Number(val));
        }
      })();
    </script>
  </body>
</html>
